defmodule TdDd.Repo.Migrations.DeletePiiInTableProfile do
  use Ecto.Migration

  def change do

    execute(
      """
      delete from public.profiles where data_structure_id not in (

      select id from public.data_structures where external_id like '%population_lsoa_2002_2011_persons/%' or external_id like '%hes_op_historic/%' or external_id like '%ecds_monthly_pi/%' or external_id like '%sgss_features_deletions/%' or external_id like '%nhs_sitrep_uec_other/%' or external_id like '%epma_prescription_dosage/%' or external_id like '%hes_op_bridge/%' or external_id like '%mmd_campy/%' or external_id like '%ecds_monthly_no_idd/%' or external_id like '%epma_prescription/%' or external_id like '%tb_daily/%' or external_id like '%sgss_core/%' or external_id like '%ons_mortality_annual/%' or external_id like '%epma_administration/%' or external_id like '%epma_administration_dosage/%' or external_id like '%ons_mortality_daily/%' or external_id like '%sgss_features/%' or external_id like '%population_gp_registered_april2017_june2022/%' or external_id like '%sgss_susceptibility/%' or external_id like '%ecds_daily_no_idd/%' or external_id like '%ons_population_projections_persons/%' or external_id like '%mmd_salmonella/%' or external_id like '%hes_cc_pi/%' or external_id like '%population_lsoa_male/%' or external_id like '%hes_ons_bridge/%' or external_id like '%population_lsoa_2002_2011_female/%' or external_id like '%hes_ons/%' or external_id like '%population_gp_registered_july2022_present/%' or external_id like '%epma_administration_dmd/%' or external_id like '%population_gp_registered_april2013_july2014/%' or external_id like '%ecds_daily_pi/%' or external_id like '%hpzone_episodes_cases/%' or external_id like '%hpzone_situations/%' or external_id like '%epma_prescription_chemical/%' or external_id like '%sgss_susceptibility_deletions/%' or external_id like '%population_lsoa_female/%' or external_id like '%ecoli_infection/%' or external_id like '%population_gp_registered_october2014_january2017/%' or external_id like '%mmd_listeria/%' or external_id like '%hes_apc_historic/%' or external_id like '%population_lsoa_2002_2011_male/%' or external_id like '%hes_op_no_idd/%' or external_id like '%imd_lsoa_2015/%' or external_id like '%mmd_yersinia/%' or external_id like '%mmd_ecoli_culture/%' or external_id like '%ons_population_projections_male/%' or external_id like '%hes_apc_no_idd/%' or external_id like '%ons_mortality_weekly/%' or external_id like '%paeruginosa_infection/%' or external_id like '%hes_cc_no_idd/%' or external_id like '%hes_ae/%' or external_id like '%nhs_sitrep_uec_covid/%' or external_id like '%hes_ae_bridge/%' or external_id like '%epma_prescription_dmd/%' or external_id like '%mmd_vibrio/%' or external_id like '%denominator_data/%' or external_id like '%population_esp/%' or external_id like '%hes_apc_pi/%' or external_id like '%reference_hes_alcohol_fractions/%' or external_id like '%kspecies_infection/%' or external_id like '%hpzone_episodes_contacts/%' or external_id like '%mmd_cores/%' or external_id like '%imd_lsoa_2019/%' or external_id like '%ons_population_projections_female/%' or external_id like '%population_lsoa_persons/%' or external_id like '%mmd_ecoli/%' or external_id like '%hes_apc_bridge/%' or external_id like '%hes_op_pi/%'
      and external_id not like '%hes_op_historic/dob' and external_id not like '%hes_op_historic/homeadd' and external_id not like '%hes_op_historic/lopatid' and external_id not like '%hes_op_historic/newnhsno' and external_id not like '%ecds_monthly_pi/birth_date' and external_id not like '%ecds_monthly_pi/local_patient_identifer' and external_id not like '%ecds_monthly_pi/nhs_number' and external_id not like '%ecds_monthly_pi/patient_pathway_identifier' and external_id not like '%epma_prescription/nhs_number' and external_id not like '%epma_prescription/patient_dob' and external_id not like '%epma_prescription/patient_postcode' and external_id not like '%tb_daily/nhsnumber' and external_id not like '%tb_daily/nhsnumbertolookup' and external_id not like '%tb_daily/forename' and external_id not like '%tb_daily/surname' and external_id not like '%tb_daily/dateofbirth' and external_id not like '%tb_daily/postcode' and external_id not like '%tb_daily/postcodetolookup' and external_id not like '%tb_daily/address' and external_id not like '%tb_daily/age' and external_id not like '%tb_daily/sex' and external_id not like '%tb_daily/ukborn' and external_id not like '%tb_daily/ethnicgroup' and external_id not like '%tb_daily/birthcountry' and external_id not like '%tb_daily/lat' and external_id not like '%tb_daily/longitude' and external_id not like '%tb_daily/pds_nhsnumber' and external_id not like '%tb_daily/pds_dateofbirth' and external_id not like '%tb_daily/pds_dateofdeath' and external_id not like '%tb_daily/pds_postcode' and external_id not like '%tb_daily/pds_died' and external_id not like '%tb_daily/pds_sex' and external_id not like '%sgss_core/patient_nhs_number' and external_id not like '%sgss_core/patient_surname' and external_id not like '%sgss_core/patient_forename' and external_id not like '%sgss_core/patient_dob' and external_id not like '%sgss_core/patient_address%' and external_id not like '%sgss_core/patient_postcode' and external_id not like '%sgss_core/patient_alt_%' and external_id not like '%sgss_core/hospital_patient_number' and external_id not like '%sgss_core/specimen_number' and external_id not like '%sgss_core/lab_comments' and external_id not like '%ons_mortality_annual/rec%' and external_id not like '%ons_mortality_annual/le%' and external_id not like '%ons_mortality_annual/pc%' and external_id not like '%ons_mortality_annual/ad%' and external_id not like '%ons_mortality_annual/agec' and external_id not like '%ons_mortality_annual/ageu%' and external_id not like '%ons_mortality_annual/ak%' and external_id not like '%ons_mortality_annual/ali%' and external_id not like '%ons_mortality_annual/dob%' and external_id not like '%ons_mortality_annual/fn%' and external_id not like '%ons_mortality_annual/nhsn%' and external_id not like '%ons_mortality_annual/na%' and external_id not like '%ons_mortality_annual/certi%' and external_id not like '%ons_mortality_annual/pobt' and external_id not like '%ons_mortality_annual/sex' and external_id not like '%ons_mortality_annual/sn%' and external_id not like '%ons_mortality_annual/agecs' and external_id not like '%epma_administration/nhs_number' and external_id not like '%epma_administration/patient_age' and external_id not like '%epma_administration/patient_postcode' and external_id not like '%ons_mortality_daily/rec%' and external_id not like '%ons_mortality_daily/le%' and external_id not like '%ons_mortality_daily/pc%' and external_id not like '%ons_mortality_daily/ad%' and external_id not like '%ons_mortality_daily/agec' and external_id not like '%ons_mortality_daily/ageu%' and external_id not like '%ons_mortality_daily/ak%' and external_id not like '%ons_mortality_daily/ali%' and external_id not like '%ons_mortality_daily/dob%' and external_id not like '%ons_mortality_daily/fn%' and external_id not like '%ons_mortality_daily/nhsn%' and external_id not like '%ons_mortality_daily/na%' and external_id not like '%ons_mortality_daily/certi%' and external_id not like '%ons_mortality_daily/pobt' and external_id not like '%ons_mortality_daily/sex' and external_id not like '%ons_mortality_daily/sn%' and external_id not like '%ons_mortality_daily/agecs' and external_id not like '%sgss_features/feature_comments' and external_id not like '%hes_cc_pi/dob' and external_id not like '%hes_cc_pi/cclocid' and external_id not like '%hes_cc_pi/lopatid' and external_id not like '%hes_cc_pi/nhsno' and external_id not like '%hes_cc_pi/susrecid' and external_id not like '%hes_ons/age_at_death' and external_id not like '%hes_ons/dod' and external_id not like '%hes_ons/dor' and external_id not like '%hes_ons/sex' and external_id not like '%ecds_daily_pi/birth_date' and external_id not like '%ecds_daily_pi/local_patient_identifer' and external_id not like '%ecds_daily_pi/nhs_number' and external_id not like '%ecds_daily_pi/patient_pathway_identifier' and external_id not like '%hpzone_episodes_cases/forename' and external_id not like '%hpzone_episodes_cases/surname' and external_id not like '%hpzone_episodes_cases/date_of_birth' and external_id not like '%hpzone_episodes_cases/nhs_number' and external_id not like '%hpzone_episodes_cases/postcode' and external_id not like '%hpzone_episodes_cases/oa11cd' and external_id not like '%hpzone_episodes_cases/lsoa11cd' and external_id not like '%hpzone_episodes_cases/current_location' and external_id not like '%hpzone_episodes_cases/recent_travel_to_another_country' and external_id not like '%hpzone_episodes_cases/age_in_years_at_date_of_onset' and external_id not like '%hpzone_episodes_cases/age_in_months_if_a_baby' and external_id not like '%hpzone_episodes_cases/occupation' and external_id not like '%ecoli_infection/ds-21-4-13' and external_id not like '%ecoli_infection/ds-21-4-20' and external_id not like '%ecoli_infection/ds-21-4-25' and external_id not like '%ecoli_infection/ds-21-4-30' and external_id not like '%ecoli_infection/ds-21-4-39' and external_id not like '%hes_apc_historic/dob' and external_id not like '%hes_apc_historic/dobbaby_1' and external_id not like '%hes_apc_historic/dobbaby_2' and external_id not like '%hes_apc_historic/dobbaby_3' and external_id not like '%hes_apc_historic/dobbaby_4' and external_id not like '%hes_apc_historic/dobbaby_5' and external_id not like '%hes_apc_historic/dobbaby_6' and external_id not like '%hes_apc_historic/dobbaby_7' and external_id not like '%hes_apc_historic/dobbaby_8' and external_id not like '%hes_apc_historic/dobbaby_9' and external_id not like '%hes_apc_historic/homeadd' and external_id not like '%hes_apc_historic/lopatid' and external_id not like '%hes_apc_historic/motdob' and external_id not like '%hes_apc_historic/newnhsno' and external_id not like '%ons_mortality_weekly/rec%' and external_id not like '%ons_mortality_weekly/le%' and external_id not like '%ons_mortality_weekly/pc%' and external_id not like '%ons_mortality_weekly/ad%' and external_id not like '%ons_mortality_weekly/agec' and external_id not like '%ons_mortality_weekly/ageu%' and external_id not like '%ons_mortality_weekly/ak%' and external_id not like '%ons_mortality_weekly/ali%' and external_id not like '%ons_mortality_weekly/dob%' and external_id not like '%ons_mortality_weekly/fn%' and external_id not like '%ons_mortality_weekly/nhsn%' and external_id not like '%ons_mortality_weekly/na%' and external_id not like '%ons_mortality_weekly/certi%' and external_id not like '%ons_mortality_weekly/pobt' and external_id not like '%ons_mortality_weekly/sex' and external_id not like '%ons_mortality_weekly/sn%' and external_id not like '%ons_mortality_weekly/agecs' and external_id not like '%paeruginosa_infection/ds-21-5-3' and external_id not like '%paeruginosa_infection/ds-21-5-23' and external_id not like '%paeruginosa_infection/ds-21-5-25' and external_id not like '%paeruginosa_infection/ds-21-5-34' and external_id not like '%paeruginosa_infection/ds-21-5-40' and external_id not like '%hes_ae/aestaffcode' and external_id not like '%hes_ae/dob' and external_id not like '%hes_ae/gridlink' and external_id not like '%hes_ae/homeadd' and external_id not like '%hes_ae/lopatid' and external_id not like '%hes_ae/mydob' and external_id not like '%hes_ae/newnhsno' and external_id not like '%hes_ae/oacode01' and external_id not like '%hes_ae/oacode11' and external_id not like '%hes_ae/reggmp' and external_id not like '%hes_apc_pi/dob' and external_id not like '%hes_apc_pi/dobbaby_1' and external_id not like '%hes_apc_pi/dobbaby_2' and external_id not like '%hes_apc_pi/dobbaby_3' and external_id not like '%hes_apc_pi/dobbaby_4' and external_id not like '%hes_apc_pi/dobbaby_5' and external_id not like '%hes_apc_pi/dobbaby_6' and external_id not like '%hes_apc_pi/dobbaby_7' and external_id not like '%hes_apc_pi/dobbaby_8' and external_id not like '%hes_apc_pi/dobbaby_9' and external_id not like '%hes_apc_pi/homeadd' and external_id not like '%hes_apc_pi/lopatid' and external_id not like '%hes_apc_pi/motdob' and external_id not like '%hes_apc_pi/newnhsno' and external_id not like '%kspecies_infection/ds-21-6-5' and external_id not like '%kspecies_infection/ds-21-6-8' and external_id not like '%kspecies_infection/ds-21-6-15' and external_id not like '%kspecies_infection/ds-21-6-28' and external_id not like '%kspecies_infection/ds-21-6-39' and external_id not like '%hpzone_episodes_contacts/forename' and external_id not like '%hpzone_episodes_contacts/surname' and external_id not like '%hpzone_episodes_contacts/date_of_birth' and external_id not like '%hpzone_episodes_contacts/nhs_number' and external_id not like '%hpzone_episodes_contacts/postcode' and external_id not like '%hpzone_episodes_contacts/oa11cd' and external_id not like '%hpzone_episodes_contacts/lsoa11cd' and external_id not like '%hpzone_episodes_contacts/current_location' and external_id not like '%hpzone_episodes_contacts/recent_travel_to_another_country' and external_id not like '%hpzone_episodes_contacts/age_in_years_at_date_of_onset' and external_id not like '%hpzone_episodes_contacts/age_in_months_if_a_baby' and external_id not like '%hpzone_episodes_contacts/occupation' and external_id not like '%mmd_cores/dob' and external_id not like '%mmd_cores/ordpatname' and external_id not like '%mmd_cores/ordpatsx' and external_id not like '%mmd_cores/ppostcode' and external_id not like '%mmd_cores/nhs_no' and external_id not like '%hes_op_pi/dob' and external_id not like '%hes_op_pi/homeadd' and external_id not like '%hes_op_pi/lopatid' and external_id not like '%hes_op_pi/newnhsno'

      )
      """

    )

    execute(
      """
      REFRESH MATERIALIZED VIEW public.vm_table_profile
      """
    )


  end
end
